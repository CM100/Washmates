<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Washmates</title>

    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Parse Javascript SDK -->
    <script src="../js/parse.js"></script>

    <!-- Moment DateTime JS library [http://momentjs.com] -->
    <script src="../js/moment.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="dashboard.html">Washmates Administration</a>
            </div>
            <!-- /.navbar-header -->

            <ul class="nav navbar-top-links navbar-right">
                <!-- /.dropdown -->
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-bell fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-alerts">
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-comment fa-fw"></i> New Comment
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-envelope fa-fw"></i> Message Sent
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-shopping-cart fa-fw"></i> New Order
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a class="text-center" href="#">
                                <strong>See All Alerts</strong>
                                <i class="fa fa-angle-right"></i>
                            </a>
                        </li>
                    </ul>
                    <!-- /.dropdown-alerts -->
                </li>
                <!-- /.dropdown -->
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-user fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#"><i class="fa fa-user fa-fw"></i> User Profile</a>
                        </li>
                        <li><a href="#"><i class="fa fa-gear fa-fw"></i> Settings</a>
                        </li>
                        <li class="divider"></li>
                        <li><a class="log-out-btn"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                        </li>
                    </ul>
                    <!-- /.dropdown-user -->
                </li>
                <!-- /.dropdown -->
            </ul>
            <!-- /.navbar-top-links -->

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <div class="input-group custom-search-form">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="input-group-btn">
                                    <button class="btn btn-default" type="button">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                            <!-- /input-group -->
                        </li>
                        <li>
                            <a href="dashboard.html"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a>
                        </li>
                        <li>
                            <a href="calendar.html"><i class="fa fa-calendar fa-fw"></i> Calendar</a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa fa-users fa-fw"></i> Users<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="users.html">List of Users</a>
                                </li>
                                <li>
                                    <a href="create-new-user.html">Create New User</a>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="laundries.html"><i class="fa fa-hospital-o fa-fw"></i> Laundries</a>
                        </li>
                        <li>
                            <a href="drivers.html"><i class="fa fa-bus fa-fw"></i> Drivers</a>
                        </li>
                        <li>
                            <a href="orders.html"><i class="fa fa-shopping-cart fa-fw"></i> Orders</a>
                        </li>
                        <li>
                            <a href="issues.html"><i class="fa fa-support fa-fw"></i> Issues</a>
                        </li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>


        <!-- Page Content -->
        <div id="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">Orders</h1>
                    </div>
                    <!-- /.col-lg-12 -->
                </div>
                <!-- /.row -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                List of all orders.
                            </div>
                            <!-- /.panel-heading -->
                            <div class="panel-body">
                                <div class="dataTable_wrapper">
                                    <table class="table table-striped table-bordered table-hover" id="orders-table"></table>
                                </div>
                            </div>
                            <!-- /.panel-body -->
                        </div>
                        <!-- /.panel -->
                    </div>
                    <!-- /.col-lg-12 -->
                </div>
                <!-- /.row -->

            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /#page-wrapper -->

        <!-- Additional Info Modal -->
        <div class="modal fade" id="additional-info-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h3>Additional Information</h3>
                    </div>
                    <div class="modal-body">
                        <div id="event-meta">
                            <div class="panel panel-info">
                                <div class="panel-heading" data-toggle="collapse" data-target="#user-details-info">
                                    <i class="fa fa-user"></i>
                                    <span>User Details</span>
                                </div>
                                <div id="user-details-info" class="collapse panel-body" style="background-color: #f5f5f5"></div>
                            </div>
                            <div class="panel panel-info">
                                <div class="panel-heading" data-toggle="collapse" data-target="#address-details-info">
                                    <i class="fa fa-home"></i>
                                    <span>Address Details</span>
                                </div>
                                <div id="address-details-info" class="collapse panel-body" style="background-color: #f5f5f5"></div>
                            </div>
                            <div class="panel panel-info">
                                <div class="panel-heading" data-toggle="collapse" data-target="#pickup-driver-details-info">
                                    <i class="fa fa-bus"></i>
                                    <span>Pickup Driver</span>
                                </div>
                                <div id="pickup-driver-details-info" class="collapse panel-body" style="background-color: #f5f5f5"></div>
                            </div>
                            <div class="panel panel-info">
                                <div class="panel-heading" data-toggle="collapse" data-target="#delivery-driver-details-info">
                                    <i class="fa fa-bus"></i>
                                    <span>Delivery Driver</span>
                                </div>
                                <div id="delivery-driver-details-info" class="collapse panel-body" style="background-color: #f5f5f5"></div>
                            </div>
                            <div class="panel panel-info">
                                <div class="panel-heading" data-toggle="collapse" data-target="#discount-info">
                                    <i class="fa fa-dollar"></i>
                                    <span>Discount Code</span>
                                </div>
                                <div id="discount-info" class="collapse panel-body" style="background-color: #f5f5f5"></div>
                            </div>
                            <div class="panel panel-info" id="receipt-table-wrapper">
                                <div class="panel-heading">
                                    <i class="fa fa-table"></i>
                                    <span>Receipt Table</span>
                                </div>
                                <div class="panel-body" style="background-color: #f5f5f5">
                                    <table id="receipt-table" class="table table-hover"></table>
                                </div>
                            </div>
                            <table id="receipt-table" class="table table-hover"></table>
                        </div>
                        <div class="modal-footer">
                            <a href="#" data-dismiss="modal" class="btn btn-primary">Close</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change order modal -->
        <div class="modal fade" id="change-order-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h3 id="change-order-modal-header">Change Order</h3>
                        <div id="change-order-label-div"></div>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label>Order Status:</label>
                                <select class="form-control" id="select-new-order-status" autocomplete="off">
                                </select>
                            </div>
                        </form>
                        <div class="text-center">
                            <div class="col-md-4"><b>Title</b>
                            </div>
                            <div class="col-md-3"><b>Quantity</b>
                            </div>
                            <div class="col-md-3"><b>Price</b>
                            </div>
                            <div class="col-md-1"></div>
                        </div>
                        <div class="form-inline">
                            <div class="input-group col-md-4">
                                <span class="input-group-addon"><i class=" fa fa-font"></i></span>
                                <input type="text" id="order-item-title" class="form-control order-item-title" placeholder="Title" />
                            </div>
                            <div class="input-group col-md-3">
                                <span class="input-group-addon"><i class="fa fa-plus"></i></span>
                                <input type="number" min="1" id="order-item-quantity" class="form-control" placeholder="Quantity" />
                            </div>
                            <div class="input-group col-md-3">
                                <span class="input-group-addon"><i class=" fa fa-dollar"></i></span>
                                <input type="text" min="0" id="order-item-price" class="form-control" placeholder="Price" />
                            </div>
                            <div class="input-group col-md-1">
                                <button type="button" class="add-new-row-control btn btn-success"><i class=" fa fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <br />
                        <table class="table table-striped table-bordered table-hover" id="modal-table"></table>
                    </div>
                    <div class="modal-footer">
                        <a href="#" class="save-order-action btn btn-primary">Save</a>
                        <a href="#" data-dismiss="modal" class="btn btn-default">Close</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="../bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>

    <script>
        var Smoothie = {
            'requirePath': ['../js/']
        }
    </script>

    <script src="../js/require.js"></script>

    <!-- Below add page script -->

    <script type="text/javascript">
        var app = require("./app");
        var parseService = require("./parseService");

        //{description: {description: "Description"}, price: {title: "Price"} }
        function ReceiptTable(table, columns) {
            var columnKeys = Object.keys(columns);

            if ( columns === undefined || Parse._.isEmpty(columns) ) {
                throw 'No options passed.';
            }

            if ( !table ) {
                throw 'No table passed.';
            }
            table = $(table);


            this._drawHeader = function(columns) {
                var headersHtmlString = '';

                table.append('<thead><tr></tr></thead>');

                columnKeys.sort().reverse().forEach(function(columnKey){
                    var headerTitle = columns[columnKey].title;
                    if( headerTitle !== undefined ) {
                        headersHtmlString += '<td>'+ headerTitle +'</td>';
                    }
                });

                table.find('thead tr').append(headersHtmlString);
            };

            this._drawBody = function() {
                return table.append('<tbody class="receipt-body"></tbody>').find('tbody');
            }

            //receiptItem: {description: 'Men's trousers x 2', price: 14}
            this._validateReceiptItem = function(receiptItem) {
                var itemKeys = Object.keys(receiptItem).sort();

                var existsColumnKeyInItemKeys = true;

                columnKeys.forEach(function(columnKey){
                    existsColumnKeyInItemKeys = existsColumnKeyInItemKeys && !!~itemKeys.indexOf(columnKey);
                });

                return existsColumnKeyInItemKeys;
            }

            this.clearTable = function() {
                table.html('');
            };

            this.addItem = function(receiptItem){
                if( !this._validateReceiptItem(receiptItem) ) {
                    throw "item keys not same as keys in column option";
                }
                var tableBody = table.find('tbody.receipt-body');
                if( tableBody.length < 1 ) {
                    tableBody = this._drawBody();
                }

                var receiptHTMLRowString = '<tr>';
                Object.keys(receiptItem).sort().reverse().forEach(function(receiptKey){
                    receiptHTMLRowString += '<td>' + receiptItem[receiptKey] + '</td>';
                });
                receiptHTMLRowString += '</tr>';
                tableBody.append(receiptHTMLRowString);
            };

            this.addDiscount = function(discountItem){
                table.append('<tbody><tr><td  "><b>Discount Code</b> <span class="label label-primary">'+ discountItem.code + '</span></td>'+ this._writeEmptyCells(columnKeys.length-2   ) +'<td>-'+ discountItem.amount +'</td></tr></tbody>');
            };

            this.addTax = function(tax){
                table.append('<tbody><tr><td><b>Taxes</b></td>'+ this._writeEmptyCells(columnKeys.length-2) +'<td>'+ tax +'</td></tr></tbody>');
            };

            this.addTotal = function(total){
                table.append('<tbody><tr><td><b>Total</b></td>'+ this._writeEmptyCells(columnKeys.length-2) +'<td>'+ total +'</td></tr></tbody>');
            }

            this._writeEmptyCells = function(numberOfCells){
                var cellsHtmlString = '';
                do {
                    numberOfCells--;
                    cellsHtmlString += '<td></td>';
                } while( numberOfCells > 0 );
                return cellsHtmlString;
            }

            this._init = function() {
                this.clearTable();
                this._drawHeader(columns);
                this._drawBody();
            }

            this._init();

        }

        app.ready(function () {
            parseService.getOrders()
                .done(function (orders) {

                    var clearModalFields = function () {
                        $('#order-item-title').val('');
                        $('#order-item-title').parent('div').removeClass('has-error');
                        $('#order-item-quantity').val('');
                        $('#order-item-quantity').parent('div').removeClass('has-error');
                        $('#order-item-price').val('');
                        $('#order-item-price').parent('div').removeClass('has-error');
                    };

                    var dataSet = new Array(orders.length);
                    for (var i = 0; i < orders.length; i++) {
                        dataSet[i] = new Array(9); // 9 is number of columns
                    }

                    for (var i = 0; i < orders.length; i++) {
                        dataSet[i][0] = orders[i].id;
                        dataSet[i][1] = orders[i].get('user').get('username').toString() || null;
                        if(orders[i].get('pickUpAddress') === undefined) {
                            dataSet[i][2] = 'N/A';
                        } else {
                            dataSet[i][2] = orders[i].get('pickUpAddress').get('street').toString() || null;
                        }
                        dataSet[i][3] = orders[i].get('pickUpDriver').get('user').get('username').toString() || null;
                        dataSet[i][4] = orders[i].get('deliveryDriver').get('user').get('username').toString() || null;
                        if (orders[i].get('laundry') !== undefined) {
                            dataSet[i][5] = orders[i].get('laundry').get('name').toString() || null;
                        } else {
                            dataSet[i][5] = null;
                        }

                        dataSet[i][6] = orders[i].createdAt.toLocaleString();
                        dataSet[i][7] = orders[i].updatedAt.toLocaleString();
                        dataSet[i][8] = null;
                    }

                    $("#orders-table").dataTable({
                        data: dataSet,
                        "columnDefs": [{
                            "targets": [8],
                            "data": null,
                            "searchable": false,
                            render: function (data, type, full, meta) {
                                return '<div class="text-center"><button data-index="' + meta.row + '" class="additional-info-action btn btn-info btn-circle" data-toggle="modal" data-target="#additional-info-modal">' + '<span class="fa fa-info-circle"></span></button>&nbsp;' + '<button data-index="' + meta.row + '" class="change-order-action btn btn-primary btn-circle" data-toggle="modal" data-target="#change-order-modal">' + '<span class="fa fa-edit"></span></button>&nbsp;' + '<button data-index="' + meta.row + '" class="btn btn-danger btn-circle" id="refund-order-btn">' + '<span class="fa fa-credit-card"></span></button></div>';
                            }

                            }],

                        columns: [
                            {
                                title: "Id"
                                },
                            {
                                title: "Customer Email"
                                },
                            {
                                title: "Address"
                                },
                            {
                                title: "Pickup Driver"
                                },
                            {
                                title: "Delivery Driver"
                                },
                            {
                                title: "Laundry"
                                },
                            {
                                title: "Created At"
                                },
                            {
                                title: "Updated At"
                                },
                            {
                                title: "Actions"
                                }
                            ]
                    });

                    $("#orders-table").on("click", ".additional-info-action", function () {
                        var userDiv = document.getElementById('user-details-info');
                        var addressDiv = document.getElementById('address-details-info');
                        var pickUpDriverDiv = document.getElementById('pickup-driver-details-info');
                        var deliveryDriverDiv = document.getElementById('delivery-driver-details-info');
                        var discountCodeDiv = document.getElementById('discount-info');

                        var index = +$(this).attr("data-index");

                        var user = orders[index].get('user');
                        if (user === undefined) return;

                        userDiv.innerHTML = 'Id: ' + user.id + '<br />' + 'Username: ' + user.get('username') + '<br />' + 'First Name: ' + user.get('fname') + '<br />' + 'Last Name: ' + user.get('lname') + '<br />' + 'Phone Number: ' + user.get('phone') + '<br />';

                        var address = orders[index].get('pickUpAddress');
                        if (address === undefined) return;

                        addressDiv.innerHTML = 'Id: ' + address.id + '<br />' + 'Location: ' + address.get('location') + '<br />' + 'State: ' + address.get('state') + '<br />' + 'City: ' + address.get('city') + '<br />' + 'Post Code: ' + address.get('postCode') + '<br />' + 'Street: ' + address.get('street') + '<br />' + 'Street Two: ' + address.get('streetTwo') + '<br />';


                        var pickUpDriver = orders[index].get('pickUpDriver');
                        if (pickUpDriver === undefined) return;

                        pickUpDriverDiv.innerHTML = 'id: ' + pickUpDriver.get('user').id + '<br />' + 'Username: ' + pickUpDriver.get('user').get('username') + '<br />' + 'First Name: ' + pickUpDriver.get('user').get('fname') + '<br />' + 'Last Name: ' + pickUpDriver.get('user').get('lname') + '<br />' + 'Phone Number: ' + pickUpDriver.get('user').get('phone') + '<br />';

                        var deliveryDriver = orders[index].get('deliveryDriver');
                        if (deliveryDriver === undefined) return;

                        deliveryDriverDiv.innerHTML = 'Id: ' + deliveryDriver.get('user').id + '<br />' + 'Username: ' + deliveryDriver.get('user').get('username') + '<br />' + 'First Name: ' + deliveryDriver.get('user').get('fname') + '<br />' + 'Last Name: ' + deliveryDriver.get('user').get('lname') + '<br />' + 'Phone Number: ' + deliveryDriver.get('user').get('phone') + '<br />';

//                        var discountCode = orders[index].get('discountCode') || "N/A";
//                        discountCodeDiv.innerHTML = 'Discount Code: ' + discountCode;

                        if (orders[index].get('paymentReceipt') !== undefined) {
                            $('#receipt-table-wrapper').show();
                            var paymentReceipt = orders[index].get('paymentReceipt');
                            var tableColumnDefinitions = {
                                title: {
                                    title: 'Item'
                                },
                                quantity: {
                                    title: 'Quantity'
                                },
                                price: {
                                    title: 'Price'
                                }
                            };
                            var table = new ReceiptTable('#receipt-table', tableColumnDefinitions);
                            paymentReceipt.services.forEach(function(service){
                                table.addItem(service);
                            });

                            if( paymentReceipt.discount ) {
                                table.addDiscount(paymentReceipt.discount);
                            }
                            if( paymentReceipt.tax ) {
                                table.addTax(paymentReceipt.tax);
                            }
                            if( paymentReceipt.total ) {
                                table.addTotal(paymentReceipt.total);
                            }

                        } else {
                            $('#receipt-table-wrapper').hide();
                        }

                    });

                    $('#orders-table').on("click", ".change-order-action", function () {
                        var orderStatuses = app.config.get('orderStatuses');

                        var index = +$(this).attr("data-index");
                        $('#change-order-modal').attr('data-index', index);

                        var order = orders[index];

                        var orderStatusNameDiv = document.getElementById('order-status-name');
                        var selectNewOrderStatus = document.getElementById('select-new-order-status');

                        var orderStatus = order.get('status');

                        selectNewOrderStatus.innerHTML = '';
                        var colorAsString = "";
                        var orderText = "";
                        for (var i = 0; i < orderStatuses.length; i++) {
                            var tempColor = orderStatuses[i].color || "#000";
                            selectNewOrderStatus.innerHTML = selectNewOrderStatus.innerHTML + '<option value="' + orderStatuses[i].name + '"<p style="color: ' + tempColor + ';">' + orderStatuses[i].text + '</p></option>';

                            if (orderStatuses[i].name === orderStatus) {
                                colorAsString = tempColor;
                                orderText = orderStatuses[i].text;
                            }
                        }
                        selectNewOrderStatus.innerHTML = selectNewOrderStatus.innerHTML + '';

                        var changeOrderLabelDiv = document.getElementById('change-order-label-div');

                        changeOrderLabelDiv.innerHTML = '<span class="label" style="color: #fff; background-color:' + colorAsString + '"> ' + orderText + '</span>'

                        $('#change-order-modal .add-new-row-control').attr('data-index', index);

                        $('#change-order-modal .save-order-action').attr('data-order-id', orders[index].id);
                        clearModalFields();
                    });

                    clearModalFields();

                    var oldDataSet = undefined;
                    var table = undefined;
                    var services = [];

                    $('#change-order-modal').on("click", ".add-new-row-control", function () {
                        var index = +$(this).attr("data-index");

                        var title = $('#order-item-title');
                        var description = $('#order-item-title').val() + " x " + $('#order-item-quantity').val();
                        var quantity = $('#order-item-quantity');
                        var price = $('#order-item-price');

                        // inputs validation
                        if (title.val() === '' || +quantity.val() === 0 || isNaN(+quantity.val()) || +price.val() === 0 || isNaN(+price.val())) {
                            if (title.val() === '') {
                                title.parent('div').addClass('has-error');
                            }
                            if (+quantity.val() === 0 || isNaN(+quantity.val())) {
                                quantity.parent('div').addClass('has-error');
                            }
                            if (+price.val() === 0 || isNaN(+price.val())) {
                                price.parent('div').addClass('has-error');
                            }

                            return;
                        }

                        var laundryService = new(Parse.Object.extend('Service'))({
                            title: title.val(),
                            description: description,
                            quantity: +quantity.val(),
                            price: +price.val()
                        });

                        laundryService.save().done(function (service) {
                            orders[index].relation('services').add(service);
                            services.push(service);
                            addRowToDataTable(service);
                        });
                    });

                    $('#select-new-order-status').on('change', function () {
                        var e = document.getElementById("select-new-order-status");
                        var newOrderStatus = e.options[e.options.selectedIndex].value;
                        var index = +$('#change-order-modal').attr('data-index');
                        orders[index].set('status', newOrderStatus);
                    });

                    // listeners for removing error classes
                    $('#order-item-title').on('focus', function () {
                        $(this).parent('div').removeClass('has-error');
                    });

                    $('#order-item-quantity').on('focus', function () {
                        $(this).parent('div').removeClass('has-error');
                    });

                    $('#order-item-price').on('focus', function () {
                        $(this).parent('div').removeClass('has-error');
                    });

                    $('#change-order-modal').on('click', '.remove-row-action', function () {
                        for (var i = 0; i < services.length; i++) {
                            if ($(this).attr('data-service-id') == services[i].id) {
                                services[i].destroy().done(function (i) {
                                    services.splice(i, 1);
                                    table.fnDeleteRow(i);
                                }.bind(this, i));
                            }
                        }
                    });

                    $('#change-order-modal').on('click', '.save-order-action', function () {
                        //TODO: needs to add check if order is changed
                        for (var i = 0; i < orders.length; i++) {
                            if ($(this).attr('data-order-id') == orders[i].id) {
                                orders[i].save().done(function () {
                                    $('#change-order-modal').hide();
                                });
                            }
                        }
                    });

                    var addRowToDataTable = function (service) {
                        var newDataSet = new Array(1);
                        newDataSet[0] = new Array(4); // 4 is number of columns

                        newDataSet[0][0] = service.id;
                        newDataSet[0][1] = service.get('title');
                        newDataSet[0][2] = service.get('quantity');
                        newDataSet[0][3] = service.get('price');

                        if (table != null) {
                            table.fnAddData(newDataSet[0]);

                            clearModalFields();
                            return;
                        }

                        table = $("#modal-table").dataTable({
                            "bPaginate": false,
                            "bFilter": false,
                            "bInfo": false,
                            "bSort": false,
                            data: newDataSet,
                            "columnDefs": [{
                                "targets": [4],
                                "data": null,
                                "searchable": false,
                                render: function (data /*[id, title, quantity, price]*/ , type, full, meta) {
                                    return '<div class="text-center"><button data-index="' + meta.row + '" class="remove-row-action btn btn-danger" data-service-id="' + data[0] + '"><span class="fa fa-minus"></span></button>';
                                }

                            }, {
                                "targets": [4],
                                show: false
                            }],

                            columns: [
                                {
                                    title: "Id"
                                },
                                {
                                    title: "Title"
                                },
                                {
                                    title: "Quantity"
                                },
                                {
                                    title: "Price"
                                },
                                {
                                    title: "Remove"
                                }
                            ]
                        });

                        clearModalFields();
                    };
                });
        });
    </script>
</body>

</html>
